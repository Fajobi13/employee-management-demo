name: Policy CI

on:
  push:
    branches: [main]
    paths:
      - 'policy/**'
  pull_request:
    branches: [main]
    paths:
      - 'policy/**'

jobs:
  verify:
    name: Verify Policies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Conftest
        run: |
          LATEST=$(curl -s https://api.github.com/repos/open-policy-agent/conftest/releases/latest | grep tag_name | cut -d '"' -f 4 | sed 's/v//')
          wget -q "https://github.com/open-policy-agent/conftest/releases/download/v${LATEST}/conftest_${LATEST}_Linux_x86_64.tar.gz"
          tar xzf conftest_${LATEST}_Linux_x86_64.tar.gz
          sudo mv conftest /usr/local/bin/

      - name: Verify Kubernetes policies
        run: conftest verify --policy policy/kubernetes

      - name: Verify Dockerfile policies
        run: conftest verify --policy policy/dockerfile

  push:
    name: Push Policies
    needs: verify
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Conftest
        run: |
          LATEST=$(curl -s https://api.github.com/repos/open-policy-agent/conftest/releases/latest | grep tag_name | cut -d '"' -f 4 | sed 's/v//')
          wget -q "https://github.com/open-policy-agent/conftest/releases/download/v${LATEST}/conftest_${LATEST}_Linux_x86_64.tar.gz"
          tar xzf conftest_${LATEST}_Linux_x86_64.tar.gz
          sudo mv conftest /usr/local/bin/

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Push policies (latest)
        run: conftest push ghcr.io/fajobi13/employee-management-demo/policies:latest --policy policy/kubernetes --policy policy/dockerfile

      - name: Push policies (SHA tag)
        run: conftest push ghcr.io/fajobi13/employee-management-demo/policies:${{ github.sha }} --policy policy/kubernetes --policy policy/dockerfile
